/*** Generated by streamline 0.10.15 (callbacks) --standalone - DO NOT EDIT ***/
var __rt=(function(){var __modules={},mod;function require(p){var m=__modules[p.substring(3)]; return m && m.exports};__modules['globals']=(mod={exports:{}});(function(module, exports){var glob = typeof global === "object" ? global : window;var secret = "_20c7abceb95c4eb88b7ca1895b1170d1";module.exports = (glob[secret] || (glob[secret] = { context: {} }));var g = glob[secret];g.runtime || Object.defineProperty(g, 'runtime', {get: function() { return g.__runtime__; },set: function(value) {if (g.__runtime__ !== value) {if (g.__runtime__) {if (/-fast$/.test(g.__runtime__) ||/-fast$/.test(value)) throw new Error("cannot mix streamline runtimes: " + g.__runtime__ + " and " + value);console.log("warning: mixing streamline runtimes: " + g.__runtime__ + " and " + value);}g.__runtime__ = value;}}});g.withContext = function(fn, cx) {return function() {var oldContext = g.context;g.context = cx || {};try {fn.apply(this, arguments)} finally {g.context = oldContext;}};};g.setPromise = function(name) {if (g.Promise) return; var req = require; if (name === true) g.Promise = typeof Promise === "function" ? Promise : req('es6-promise');else g.Promise = require(name);};})(mod, mod.exports);__modules['util/future']=(mod={exports:{}});(function(module, exports){(function(exports) {var globals = require("../globals");exports.future = function(fn, args, i) {var err, result, done, q = [], self = this;args = Array.prototype.slice.call(args);args[i] = function(e, r) {err = e, result = r, done = true;q && q.forEach(function(f) {f.call(self, e, r);});q = null;};args[i].__futurecb = true;fn.apply(this, args);var ret = function F(cb) {if (typeof cb !== 'function') {var globals = require('../globals');if (cb == null && globals.Promise) return exports.promise.call(this, F, [], 0);if (cb !== false && !globals.oldStyleFutures) throw new Error("callback missing (argument #0). See https://github.com/Sage/streamlinejs/blob/master/FAQ.md#no-callback-given-error");return F;}if (done) cb.call(self, err, result);else q.push(cb);};ret.__future = true;return ret;};exports.streamlinify = function(fn, idx) {return function() {if (!arguments[idx]) return exports.future.call(this, fn, arguments, idx);else return fn.apply(this, arguments);};};exports.promise = function(fn, args, i) {if (args[i] === false) return exports.future.call(this, fn, args, i);if (args[i] != null) throw new Error("invalid callback: " + typeof(args[i]));if (globals.oldStyleFutures) return exports.future.call(this, fn, args, i);if (!globals.Promise) throw new Error("callback missing (argument #" + i + "). See https://github.com/Sage/streamlinejs/blob/master/FAQ.md#no-callback-given-error");var self = this;args = Array.prototype.slice.call(args);return new globals.Promise(function(resolve, reject) {args[i] = function(e, r) {if (e) reject(e);else resolve(r);};fn.apply(self, args);});};exports.then = function(promise, method, cb) {promise[method](function(r) {cb && cb(null, r);cb = null;}, function(e) {cb && cb(e);cb = null;});};})(typeof exports !== 'undefined' ? exports : (Streamline.future = Streamline.future || {}));})(mod, mod.exports);__modules['callbacks/runtime']=(mod={exports:{}});(function(module, exports){(function(exports) {var __g = require("../globals");__g.runtime = 'callbacks';var __fut = require("../util/future");__g.context = __g.context || {};__g.depth = __g.depth || 0;__g.async = __g.async || false;__g.trampoline = (function() {var q = [];return {queue: function(fn) {q.push(fn);},flush: function() {__g.depth++;try {var fn;while (fn = q.shift()) fn();} finally {__g.depth--;}}}})();exports.runtime = function(filename, oldStyleFutures) {__g.oldStyleFutures = oldStyleFutures;function __func(_, __this, __arguments, fn, index, frame, body) {if (typeof _ !== 'function') return __fut.promise.call(__this, fn, __arguments, index);frame.file = filename;frame.prev = __g.frame;frame.calls = 0;if (frame.prev) frame.prev.calls++;var emitter = __g.emitter;__g.frame = frame;__g.depth++;if (emitter) emitter.emit("enter", frame, _); try {frame.active = true;body();} catch (e) {__setEF(e, frame.prev);__propagate(_, e);} finally {frame.active = false;if (emitter) {emitter.emit("exit", frame);}__g.frame = frame.prev;if (--__g.depth === 0 && __g.trampoline) __g.trampoline.flush();}}return {__g: __g,__func: __func,__cb: __cb,__future: __fut.future,__propagate: __propagate,__trap: __trap,__tryCatch: __tryCatch,__catch: __catch,__forIn: __forIn,__apply: __apply,__construct: __construct,__setEF: __setEF,streamlinify: __fut.streamlinify,__pthen: __fut.then,};};function __cb(_, frame, offset, col, fn, trampo, returnArray) {frame.offset = offset;frame.col = col;var ctx = __g.context;var calls = frame.calls;var emitter = __g.emitter;var ret = function ___(err, result) {if (returnArray) result = Array.prototype.slice.call(arguments, 1);returnArray = false; var oldFrame = __g.frame;__g.frame = frame;var oldContext = __g.context;__g.context = ctx;if (emitter && __g.depth === 0) emitter.emit('resume', frame);if (emitter) emitter.emit('enter', frame);__g.depth++;try {if (trampo && frame.active && __g.trampoline) {__g.trampoline.queue(function() {return ___(err, result);});} else {___.dispatched = true;if (err) {__setEF(err, frame);return _(err);}frame.active = true;return fn(null, result);}} catch (ex) {if (___.dispatched && _.name !== '___' && _.name !== '__trap' && calls !== frame.calls) throw ex;__setEF(ex, frame);return __propagate(_, ex);} finally {frame.active = false;if (emitter) emitter.emit("exit", frame);__g.frame = oldFrame;if (--__g.depth === 0 && __g.trampoline) __g.trampoline.flush();__g.context = oldContext;}};if (emitter && !ret.dispatched) emitter.emit('yield', frame);ret.__streamlined = true;return ret;}function __propagate(_, err) {try {_(err);} catch (ex) {__trap(ex);}}function __trap(err) {if (err) {if (__g.context && __g.context.errorHandler) __g.context.errorHandler(err);else process.nextTick(function() {throw err;});}}function __tryCatch(_, fn) {try {fn();} catch (e) {try {_(e);} catch (ex) {__trap(ex);}}}function __catch(fn, _) {var frame = __g.frame,context = __g.context;__g.trampoline.queue(function() {var oldFrame = __g.frame,oldContext = __g.context;__g.frame = frame;__g.context = context;try {fn();} catch (ex) {_(ex);} finally {__g.frame = oldFrame;__g.context = oldContext;}});}function __forIn(object) {var array = [];for (var obj in object) {array.push(obj);}return array;}function __apply(cb, fn, thisObj, args, index) {if (cb == null) return __fut.future(__apply, arguments, 0);args = Array.prototype.slice.call(args, 0);args[index != null ? index : args.length] = cb;return fn.apply(thisObj, args);}function __construct(constructor, i) {var key = '__async' + i,f;return constructor[key] || (constructor[key] = function() {var args = arguments;function F() {var self = this;var cb = args[i];args[i] = function(e, r) {cb(e, self);};args[i].__streamlined = cb.__streamlined;args[i].__futurecb = cb.__futurecb;return constructor.apply(self, args);}F.prototype = constructor.prototype;return new F();});}function __setEF(e, f) {function formatStack(e, raw) {var ff = typeof navigator === 'object' && navigator.userAgent.toLowerCase().indexOf('firefox') > -1;if (ff) raw = "Error: " + e.message + '\n' + raw;var s = raw,f, skip;var cut = (e.message || '').split('\n').length;var lines = s.split('\n');s = lines.slice(cut).map(function(l) {var m = /([^@]*)\@(.*?)\:(\d+)(?:\:(\d+))?$/.exec(l);l = m ? "  at " + m[1] + " (" + m[2] + ":" + parseInt(m[3]) + ":" + (m[4] || "0") + ")" : l;var i = l.indexOf('__$');if (i >= 0 && !skip) {skip = true;return l.substring(0, i) + l.substring(i + 3);}return skip ? '' : l;}).filter(function(l) {return l;}).join('\n');s = lines.slice(0, cut).join('\n') + '\n  <<< async stack >>>' + (skip ? '\n' + s : '');for (var f = e.__frame; f; f = f.prev) {if (f.offset >= 0) s += "\n  at " + f.name + " (" + f.file + ":" + (f.line + f.offset) + ":" + (f.col+1) + ")"}s += '\n  <<< raw stack >>>' + '\n' + lines.slice(cut).join('\n');return s;};e.__frame = e.__frame || f;if (exports.stackTraceEnabled && e.__lookupGetter__ && e.__lookupGetter__("rawStack") == null) {var getter = e.__lookupGetter__("stack");if (!getter) { var raw = e.stack || "raw stack unavailable";getter = function() {return raw;}}e.__defineGetter__("rawStack", getter);e.__defineGetter__("stack", function() {return formatStack(e, getter());});}}exports.stackTraceEnabled = true;})(typeof exports !== 'undefined' ? exports : (Streamline.runtime = Streamline.runtime || {}));require && require("../callbacks/builtins");})(mod, mod.exports);__modules['callbacks/builtins']=(mod={exports:{}});(function(module, exports){var __rt=require('../callbacks/runtime').runtime(__filename, false),__func=__rt.__func,__cb=__rt.__cb; (function(exports) {"use strict";var VERSION = 3;var future = function(fn, args, i) {var err, result, done, q = [], self = this;args = Array.prototype.slice.call(args);args[i] = function(e, r) {err = e, result = r, done = true;(q && q.forEach(function(f) {f.call(self, e, r); }));q = null; };fn.apply(this, args);return function F(cb) {if (!cb) { return F };if (done) { cb.call(self, err, result); } else {q.push(cb); }; }; };exports.funnel = function(max) {max = ((max == null) ? -1 : max);if ((max === 0)) { max = funnel.defaultSize; };if ((typeof max !== "number")) { throw new Error(("bad max number: " + max)) };var queue = [], active = 0, closed = false;var funCb = function(callback, fn) {if ((callback == null)) { return future(funCb, arguments, 0) };if (((max < 0) || (max == Infinity))) { return fn(callback) };queue.push({fn: fn,cb: callback });function _doOne() {var current = queue.splice(0, 1)[0];if (!current.cb) { return current.fn() };active++;current.fn(function(err, result) {active--;if (!closed) {current.cb(err, result);while (((active < max) && (queue.length > 0))) { _doOne();; }; } ; }); };while (((active < max) && (queue.length > 0))) { _doOne();; }; };var fun = __rt.streamlinify(funCb, 0);fun.close = function() {queue = [], closed = true; };return fun; };var funnel = exports.funnel;funnel.defaultSize = 4;function _parallel(options) {if ((typeof options === "number")) { return options };if ((typeof options.parallel === "number")) { return options.parallel };return (options.parallel ? -1 : 1); };if ((Array.prototype.forEach_ && (Array.prototype.forEach_.version_ >= VERSION))) { return };try {Object.defineProperty({ }, "x", { });} catch (e) {return; };var has = Object.prototype.hasOwnProperty;delete Array.prototype.forEach_;Object.defineProperty(Array.prototype, "forEach_", {configurable: true,writable: true,enumerable: false,value: function value__1(_, options, fn, thisObj) { var par, len, i, __this = this; var __frame = { name: "value__1", line: 124 }; return __func(_, this, arguments, value__1, 0, __frame, function __$value__1() {if ((typeof options === "function")) { thisObj = fn, fn = options, options = 1; } ;par = _parallel(options);thisObj = ((thisObj !== undefined) ? thisObj : __this);len = __this.length; return (function __$value__1(__then) {if (((par === 1) || (len <= 1))) {i = 0; var __2 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__1() { __more = false; if (__2) { i++; } else { __2 = true; } ; var __1 = (i < len); if (__1) { return (function __$value__1(__then) {if (has.call(__this, i)) { return fn.call(thisObj, __cb(_, __frame, 7, 31, __then, true), __this[i], i); } else { __then(); } ; })(function __$value__1() { while (__more) { __loop(); }; __more = true; }); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } else {return __this.map_(__cb(_, __frame, 10, 9, __then, true), par, fn, thisObj); } ; })(function __$value__1() { return _(null, __this); }); }); } });Array.prototype.forEach_.version_ = VERSION;delete Array.prototype.map_;Object.defineProperty(Array.prototype, "map_", {configurable: true,writable: true,enumerable: false,value: function value__2(_, options, fn, thisObj) { var par, len, result, i, fun, __this = this; var __frame = { name: "value__2", line: 147 }; return __func(_, this, arguments, value__2, 0, __frame, function __$value__2() {if ((typeof options === "function")) { thisObj = fn, fn = options, options = 1; } ;par = _parallel(options);thisObj = ((thisObj !== undefined) ? thisObj : __this);len = __this.length; return (function __$value__2(__then) {if (((par === 1) || (len <= 1))) {result = new Array(len);i = 0; var __4 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__2() { __more = false; if (__4) { i++; } else { __4 = true; } ; var __3 = (i < len); if (__3) { return (function __$value__2(__then) {if (has.call(__this, i)) { return fn.call(thisObj, __cb(_, __frame, 9, 43, function ___(__0, __1) { result[i] = __1; __then(); }, true), __this[i], i); } else { __then(); } ; })(function __$value__2() { while (__more) { __loop(); }; __more = true; }); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } else {fun = funnel(par);result = __this.map(function(elt, i) {return fun(false, function __1(_) { var __frame = { name: "__1", line: 161 }; return __func(_, this, arguments, __1, 0, __frame, function __$__1() {return fn.call(thisObj, __cb(_, __frame, 1, 16, _, true), elt, i); }); }); });i = 0; var __7 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__2() { __more = false; if (__7) { i++; } else { __7 = true; } ; var __6 = (i < len); if (__6) { return (function __$value__2(__then) {if (has.call(__this, i)) { return result[i](__cb(_, __frame, 19, 40, function ___(__0, __2) { result[i] = __2; __then(); }, true)); } else { __then(); } ; })(function __$value__2() { while (__more) { __loop(); }; __more = true; }); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } ; })(function __$value__2() {return _(null, result); }); }); } });delete Array.prototype.filter_;Object.defineProperty(Array.prototype, "filter_", {configurable: true,writable: true,enumerable: false,value: function value__3(_, options, fn, thisObj) { var par, result, len, i, elt, __this = this; var __frame = { name: "value__3", line: 179 }; return __func(_, this, arguments, value__3, 0, __frame, function __$value__3() {if ((typeof options === "function")) { thisObj = fn, fn = options, options = 1; } ;par = _parallel(options);thisObj = ((thisObj !== undefined) ? thisObj : __this);result = [];len = __this.length; return (function __$value__3(__then) {if (((par === 1) || (len <= 1))) {i = 0; var __4 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__3() { __more = false; if (__4) { i++; } else { __4 = true; } ; var __3 = (i < len); if (__3) { return (function __$value__3(__then) {if (has.call(__this, i)) {elt = __this[i];return fn.call(thisObj, __cb(_, __frame, 10, 13, function ___(__0, __2) { return (function __$value__3(__then) { if (__2) { result.push(elt); __then(); } else { __then(); } ; })(__then); }, true), elt); } else { __then(); } ; })(function __$value__3() { while (__more) { __loop(); }; __more = true; }); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } else {return __this.map_(__cb(_, __frame, 14, 9, __then, true), par, function __1(_, elt) { var __frame = { name: "__1", line: 193 }; return __func(_, this, arguments, __1, 0, __frame, function __$__1() {return fn.call(thisObj, __cb(_, __frame, 1, 12, function ___(__0, __1) { return (function __$__1(__then) { if (__1) { result.push(elt); __then(); } else { __then(); } ; })(_); }, true), elt); });}, thisObj); } ; })(function __$value__3() {return _(null, result); }); }); } });delete Array.prototype.every_;Object.defineProperty(Array.prototype, "every_", {configurable: true,writable: true,enumerable: false,value: function value__4(_, options, fn, thisObj) { var par, len, i, fun, futures, __this = this; var __frame = { name: "value__4", line: 207 }; return __func(_, this, arguments, value__4, 0, __frame, function __$value__4() {if ((typeof options === "function")) { thisObj = fn, fn = options, options = 1; } ;par = _parallel(options);thisObj = ((thisObj !== undefined) ? thisObj : __this);len = __this.length; return (function __$value__4(__then) {if (((par === 1) || (len <= 1))) {i = 0; var __6 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__4() { __more = false; if (__6) { i++; } else { __6 = true; } ; var __5 = (i < len); if (__5) { return (function __$value__4(_) {var __1 = has.call(__this, i); if (!__1) { return _(null, __1); } ; return fn.call(thisObj, __cb(_, __frame, 8, 34, function ___(__0, __3) { var __2 = !__3; return _(null, __2); }, true), __this[i]); })(__cb(_, __frame, -206, 17, function ___(__0, __3) { return (function __$value__4(__then) { if (__3) { return _(null, false); } else { __then(); } ; })(function __$value__4() { while (__more) { __loop(); }; __more = true; }); }, true)); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } else {fun = funnel(par);futures = __this.map(function(elt) {return fun(false, function __1(_) { var __frame = { name: "__1", line: 220 }; return __func(_, this, arguments, __1, 0, __frame, function __$__1() {return fn.call(thisObj, __cb(_, __frame, 1, 16, _, true), elt); }); }); });i = 0; var __9 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__4() { __more = false; if (__9) { i++; } else { __9 = true; } ; var __8 = (i < len); if (__8) { return (function __$value__4(_) {var __2 = has.call(__this, i); if (!__2) { return _(null, __2); } ; return futures[i](__cb(_, __frame, 18, 31, function ___(__0, __4) { var __3 = !__4; return _(null, __3); }, true)); })(__cb(_, __frame, -206, 17, function ___(__0, __4) { return (function __$value__4(__then) { if (__4) {fun.close();return _(null, false); } else { __then(); } ; })(function __$value__4() { while (__more) { __loop(); }; __more = true; }); }, true)); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } ; })(function __$value__4() {return _(null, true); }); }); } });delete Array.prototype.some_;Object.defineProperty(Array.prototype, "some_", {configurable: true,writable: true,enumerable: false,value: function value__5(_, options, fn, thisObj) { var par, len, i, fun, futures, __this = this; var __frame = { name: "value__5", line: 241 }; return __func(_, this, arguments, value__5, 0, __frame, function __$value__5() {if ((typeof options === "function")) { thisObj = fn, fn = options, options = 1; } ;par = _parallel(options);thisObj = ((thisObj !== undefined) ? thisObj : __this);len = __this.length; return (function __$value__5(__then) {if (((par === 1) || (len <= 1))) {i = 0; var __6 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__5() { __more = false; if (__6) { i++; } else { __6 = true; } ; var __5 = (i < len); if (__5) { return (function __$value__5(_) {var __1 = has.call(__this, i); if (!__1) { return _(null, __1); } ; return fn.call(thisObj, __cb(_, __frame, 7, 33, _, true), __this[i]); })(__cb(_, __frame, -240, 17, function ___(__0, __3) { return (function __$value__5(__then) { if (__3) { return _(null, true); } else { __then(); } ; })(function __$value__5() { while (__more) { __loop(); }; __more = true; }); }, true)); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } else {fun = funnel(par);futures = __this.map(function(elt) {return fun(false, function __1(_) { var __frame = { name: "__1", line: 253 }; return __func(_, this, arguments, __1, 0, __frame, function __$__1() {return fn.call(thisObj, __cb(_, __frame, 1, 16, _, true), elt); }); }); });i = 0; var __9 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__5() { __more = false; if (__9) { i++; } else { __9 = true; } ; var __8 = (i < len); if (__8) { return (function __$value__5(_) {var __2 = has.call(__this, i); if (!__2) { return _(null, __2); } ; return futures[i](__cb(_, __frame, 17, 30, _, true)); })(__cb(_, __frame, -240, 17, function ___(__0, __4) { return (function __$value__5(__then) { if (__4) {fun.close();return _(null, true); } else { __then(); } ; })(function __$value__5() { while (__more) { __loop(); }; __more = true; }); }, true)); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } ; })(function __$value__5() {return _(null, false); }); }); } });delete Array.prototype.reduce_;Object.defineProperty(Array.prototype, "reduce_", {configurable: true,writable: true,enumerable: false,value: function value__6(_, fn, v, thisObj) { var len, i, __this = this; var __frame = { name: "value__6", line: 274 }; return __func(_, this, arguments, value__6, 0, __frame, function __$value__6() {thisObj = ((thisObj !== undefined) ? thisObj : __this);len = __this.length;i = 0; var __3 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__6() { __more = false; if (__3) { i++; } else { __3 = true; } ; var __2 = (i < len); if (__2) { return (function __$value__6(__then) {if (has.call(__this, i)) { return fn.call(thisObj, __cb(_, __frame, 4, 34, function ___(__0, __1) { v = __1; __then(); }, true), v, __this[i], i, __this); } else { __then(); } ; })(function __$value__6() { while (__more) { __loop(); }; __more = true; }); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(function __$value__6() {return _(null, v); }); }); } });delete Array.prototype.reduceRight_;Object.defineProperty(Array.prototype, "reduceRight_", {configurable: true,writable: true,enumerable: false,value: function value__7(_, fn, v, thisObj) { var len, i, __this = this; var __frame = { name: "value__7", line: 290 }; return __func(_, this, arguments, value__7, 0, __frame, function __$value__7() {thisObj = ((thisObj !== undefined) ? thisObj : __this);len = __this.length;i = (len - 1); var __3 = false; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$value__7() { __more = false; if (__3) { i--; } else { __3 = true; } ; var __2 = (i >= 0); if (__2) { return (function __$value__7(__then) {if (has.call(__this, i)) { return fn.call(thisObj, __cb(_, __frame, 4, 34, function ___(__0, __1) { v = __1; __then(); }, true), v, __this[i], i, __this); } else { __then(); } ; })(function __$value__7() { while (__more) { __loop(); }; __more = true; }); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(function __$value__7() {return _(null, v); }); }); } });delete Array.prototype.sort_;Object.defineProperty(Array.prototype, "sort_", {configurable: true,writable: true,enumerable: false,value: function value__8(_, compare, beg, end) { var array, __this = this;function _qsort(_, beg, end) { var tmp, mid, o, nbeg, nend; var __frame = { name: "_qsort", line: 313 }; return __func(_, this, arguments, _qsort, 0, __frame, function __$_qsort() {if ((beg >= end)) { return _(null); } ; return (function __$_qsort(__then) {if ((end == (beg + 1))) {return compare(__cb(_, __frame, 4, 9, function ___(__0, __4) { var __3 = (__4 > 0); return (function __$_qsort(__then) { if (__3) {tmp = array[beg];array[beg] = array[end];array[end] = tmp; __then(); } else { __then(); } ; })(function __$_qsort() { return _(null); }); }, true), array[beg], array[end]); } else { __then(); } ; })(function __$_qsort() {mid = Math.floor((((beg + end)) / 2));o = array[mid];nbeg = beg;nend = end; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$_qsort() { __more = false;var __6 = (nbeg <= nend); if (__6) { return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$_qsort() { __more = false; return (function __$_qsort(_) { return (function __$_qsort(_) {var __1 = (nbeg < end); if (!__1) { return _(null, __1); } ; return compare(__cb(_, __frame, 18, 26, function ___(__0, __3) { var __2 = (__3 < 0); return _(null, __2); }, true), array[nbeg], o); })(__cb(_, __frame, -312, 17, _, true)); })(__cb(_, __frame, -312, 17, function ___(__0, __7) { if (__7) { nbeg++; while (__more) { __loop(); }; __more = true; } else { __break(); } ; }, true)); }); do { __loop(); } while (__more); __more = true; })(function __$_qsort() { return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$_qsort() { __more = false; return (function __$_qsort(_) { return (function __$_qsort(_) {var __2 = (beg < nend); if (!__2) { return _(null, __2); } ; return compare(__cb(_, __frame, 19, 26, function ___(__0, __4) { var __3 = (__4 < 0); return _(null, __3); }, true), o, array[nend]); })(__cb(_, __frame, -312, 17, _, true)); })(__cb(_, __frame, -312, 17, function ___(__0, __9) { if (__9) { nend--; while (__more) { __loop(); }; __more = true; } else { __break(); } ; }, true)); }); do { __loop(); } while (__more); __more = true; })(function __$_qsort() {if ((nbeg <= nend)) {tmp = array[nbeg];array[nbeg] = array[nend];array[nend] = tmp;nbeg++;nend--; } ; while (__more) { __loop(); }; __more = true; }); }); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(function __$_qsort() { return (function __$_qsort(__then) {if ((nbeg < end)) { return _qsort(__cb(_, __frame, 30, 20, __then, true), nbeg, end); } else { __then(); } ; })(function __$_qsort() { return (function __$_qsort(__then) {if ((beg < nend)) { return _qsort(__cb(_, __frame, 31, 20, __then, true), beg, nend); } else { __then(); } ; })(_); }); }); }); }); }; var __frame = { name: "value__8", line: 308 }; return __func(_, this, arguments, value__8, 0, __frame, function __$value__8() { array = __this; beg = (beg || 0); end = ((end == null) ? (array.length - 1) : end);return _qsort(__cb(_, __frame, 38, 3, function __$value__8() {return _(null, array); }, true), beg, end); }); } });delete Function.prototype.apply_;Object.defineProperty(Function.prototype, "apply_", {configurable: true,writable: true,enumerable: false,value: function(callback, thisObj, args, index) {args = Array.prototype.slice.call(args, 0);args.splice((((index != null) && (index >= 0)) ? index : args.length), 0, callback);return this.apply(thisObj, args); } });})(((typeof exports !== "undefined") ? exports : (Streamline.builtins = (Streamline.builtins || {}))));})(mod, mod.exports);return __modules['callbacks/runtime'].exports.runtime('lib/Node._coffee', false);})(),__func=__rt.__func,__cb=__rt.__cb,__catch=__rt.__catch,__tryCatch=__rt.__tryCatch,__apply=__rt.__apply;
(function() {
  var Node, Path, PropertyContainer, Relationship, adjustError, status, util, __hasProp = {
  }.hasOwnProperty, __extends = function(child, parent) {
    for (var key in parent) {
      if (__hasProp.call(parent, key)) {
        child[key] = parent[key];
      };
    };
    function ctor() {
      this.constructor = child;
    };
    ctor.prototype = parent.prototype;
    child.prototype = new ctor();
    child.__super__ = parent.prototype;
    return child;
  };
  status = require("http-status");
  util = require("./util");
  adjustError = util.adjustError;
  PropertyContainer = require("./PropertyContainer");
  Relationship = require("./Relationship");
  Path = require("./Path");
  module.exports = Node = (function(_super) {
    __extends(Node, _super);
    function Node(db, data) {
      Node.__super__.constructor.call(this, db, data);
    };
    Node.prototype.toString = function() {
      if (this.exists) {
        return ("node @" + this.id);
      }
       else {
        return (("unsaved node (" + (JSON.stringify(this.data, null, 4))) + ")");
      }
      ;
    };
    Node.prototype.save = function Node_prototype_save__1(_) {
      var error, response, services, __this = this;
      var __frame = {
        name: "Node_prototype_save__1",
        line: 43
      };
      return __func(_, this, arguments, Node_prototype_save__1, 0, __frame, function __$Node_prototype_save__1() {
        return (function ___(__then) {
          (function ___(_) {
            __tryCatch(_, function __$Node_prototype_save__1() {
              return (function __$Node_prototype_save__1(__then) {
                if (__this.exists) {
                  return __this._request.put({
                    uri: (("" + __this.self) + "/properties"),
                    json: __this.data
                  }, __cb(_, __frame, 4, 37, function ___(__0, __1) {
                    response = __1;
                    if ((response.statusCode !== status.NO_CONTENT)) {
                      switch (response.statusCode) {
                      case status.BAD_REQUEST:
                        return _(new Error("Invalid data sent"));
                      case status.NOT_FOUND:
                        return _(new Error("Node not found"));
                        default:
                        return _(response);
                      };
                    }
                    ;
                    __then();
                  }, true));
                }
                 else {
                  return __this.db.getServices(__cb(_, __frame, 19, 31, function ___(__0, __2) {
                    services = __2;
                    return __this._request.post({
                      uri: services.node,
                      json: __this.data
                    }, __cb(_, __frame, 21, 37, function ___(__0, __3) {
                      response = __3;
                      if ((response.statusCode !== status.CREATED)) {
                        switch (response.statusCode) {
                        case status.BAD_REQUEST:
                          return _(new Error("Invalid data sent"));
                          default:
                          return _(response);
                        };
                      }
                      ;
                      __this._data = response.body;
                      __then();
                    }, true));
                  }, true));
                }
                ;
              })(function __$Node_prototype_save__1() {
                return _(null, __this);
              });
            });
          })(function ___(_error, __result) {
            __catch(function __$Node_prototype_save__1() {
              if (_error) {
                error = _error;
                return _(adjustError(error));
              }
               else {
                _(null, __result);
              }
              ;
            }, _);
          });
        })(function ___() {
          __tryCatch(_, function __$Node_prototype_save__1() {
            _();
          });
        });
      });
    };
    Node.prototype["delete"] = function Node_prototype_delete__2(_, force) {
      var error, relationships, __this = this, __arguments = arguments;
      var __frame = {
        name: "Node_prototype_delete__2",
        line: 97
      };
      return __func(_, this, arguments, Node_prototype_delete__2, 0, __frame, function __$Node_prototype_delete__2() {
        if ((force == null)) {
          force = false;
        }
        ;
        if (!__this.exists) {
          return _(null);
        }
        ;
        return (function ___(__then) {
          (function ___(_) {
            __tryCatch(_, function __$Node_prototype_delete__2() {
              return (function __$Node_prototype_delete__2(__then) {
                if (force) {
                  return __this.all(null, __cb(_, __frame, 8, 33, function ___(__0, __2) {
                    relationships = __2;
                    return relationships.forEach_(__cb(_, __frame, 9, 30, __then, true), {
                      parallel: true
                    }, function __1(_, rel) {
                      var __frame = {
                        name: "__1",
                        line: 106
                      };
                      return __func(_, this, arguments, __1, 0, __frame, function __$__1() {
                        return rel["delete"](__cb(_, __frame, 1, 20, _, true));
                      });
                    });
                  }, true));
                }
                 else {
                  __then();
                }
                ;
              })(__then);
            });
          })(function ___(_error, __result) {
            __catch(function __$Node_prototype_delete__2() {
              if (_error) {
                error = _error;
                return _(adjustError(error));
              }
               else {
                _(null, __result);
              }
              ;
            }, _);
          });
        })(function ___() {
          __tryCatch(_, function __$Node_prototype_delete__2() {
            return __apply(__cb(_, __frame, NaN, 0, _, true), Node.__super__["delete"], __this, __arguments, 0);
          });
        });
      });
    };
    Node.prototype.index = function Node_prototype_index__3(index, key, value, _) {
      var error, response, services, __this = this;
      var __frame = {
        name: "Node_prototype_index__3",
        line: 123
      };
      return __func(_, this, arguments, Node_prototype_index__3, 3, __frame, function __$Node_prototype_index__3() {
        return (function ___(__then) {
          (function ___(_) {
            __tryCatch(_, function __$Node_prototype_index__3() {
              if (!__this.exists) {
                return _(new Error("Node must exist before indexing."));
              }
              ;
              return __this.db.getServices(__cb(_, __frame, 5, 27, function ___(__0, __1) {
                services = __1;
                return __this._request.post({
                  url: ((("" + services.node_index) + "/") + index),
                  json: {
                    key: key,
                    value: value,
                    uri: __this.self
                  }
                }, __cb(_, __frame, 7, 33, function ___(__0, __2) {
                  response = __2;
                  if ((response.statusCode !== status.CREATED)) {
                    return _(response);
                  }
                  ;
                  __then();
                }, true));
              }, true));
            });
          })(function ___(_error, __result) {
            __catch(function __$Node_prototype_index__3() {
              if (_error) {
                error = _error;
                return _(adjustError(error));
              }
               else {
                _(null, __result);
              }
              ;
            }, _);
          });
        })(function ___() {
          __tryCatch(_, function __$Node_prototype_index__3() {
            _();
          });
        });
      });
    };
    Node.prototype.unindex = function Node_prototype_unindex__4(index, key, value, _) {
      var base, error, response, services, url, __this = this;
      var __frame = {
        name: "Node_prototype_unindex__4",
        line: 157
      };
      return __func(_, this, arguments, Node_prototype_unindex__4, 3, __frame, function __$Node_prototype_unindex__4() {
        return (function ___(__then) {
          (function ___(_) {
            __tryCatch(_, function __$Node_prototype_unindex__4() {
              if (!__this.exists) {
                return _(new Error("Node must exist before unindexing."));
              }
              ;
              return __this.db.getServices(__cb(_, __frame, 7, 27, function ___(__0, __1) {
                services = __1;
                if (key) {
                  key = encodeURIComponent(key);
                }
                ;
                if (value) {
                  value = encodeURIComponent(value);
                }
                ;
                base = ((("" + services.node_index) + "/") + (encodeURIComponent(index)));
                url = ((key && value) ? ((((((("" + base) + "/") + key) + "/") + value) + "/") + __this.id) : (key ? ((((("" + base) + "/") + key) + "/") + __this.id) : ((("" + base) + "/") + __this.id)));
                return __this._request.del(url, __cb(_, __frame, 20, 33, function ___(__0, __2) {
                  response = __2;
                  if ((response.statusCode !== status.NO_CONTENT)) {
                    return _(response);
                  }
                  ;
                  __then();
                }, true));
              }, true));
            });
          })(function ___(_error, __result) {
            __catch(function __$Node_prototype_unindex__4() {
              if (_error) {
                error = _error;
                return _(adjustError(error));
              }
               else {
                _(null, __result);
              }
              ;
            }, _);
          });
        })(function ___() {
          __tryCatch(_, function __$Node_prototype_unindex__4() {
            _();
          });
        });
      });
    };
    (function(actual) {
      return Node.prototype.unindex = function(index, key, value, callback) {
        if ((typeof key === "function")) {
          callback = key;
          key = null;
          value = null;
        }
         else if ((typeof value === "function")) {
          callback = value;
          value = null;
        }
        
        ;
        return actual.call(this, index, key, value, callback);
      };
    })(Node.prototype.unindex);
    Node.prototype.createRelationshipTo = function(otherNode, type, data, cb) {
      if ((typeof data === "function")) {
        cb = data;
        data = null;
      }
      ;
      return this._createRelationship(this, otherNode, type, data, cb);
    };
    Node.prototype.createRelationshipFrom = function(otherNode, type, data, cb) {
      if ((typeof data === "function")) {
        cb = data;
        data = null;
      }
      ;
      return this._createRelationship(otherNode, this, type, data, cb);
    };
    Node.prototype._createRelationship = function Node_prototype__createRelationship__5(from, to, type, data, _) {
      var createRelationshipURL, error, exception, message, otherNodeURL, response, _ref, __this = this;
      var __frame = {
        name: "Node_prototype__createRelationship__5",
        line: 250
      };
      return __func(_, this, arguments, Node_prototype__createRelationship__5, 4, __frame, function __$Node_prototype__createRelationship__5() {
        if ((data == null)) {
          data = {
          };
        }
        ;
        return (function ___(__then) {
          (function ___(_) {
            __tryCatch(_, function __$Node_prototype__createRelationship__5() {
              createRelationshipURL = from._data["create_relationship"];
              otherNodeURL = to.self;
              return (function __$Node_prototype__createRelationship__5(__then) {
                if ((((createRelationshipURL != null)) && otherNodeURL)) {
                  return __this._request.post({
                    url: createRelationshipURL,
                    json: {
                      to: otherNodeURL,
                      data: data,
                      type: type
                    }
                  }, __cb(_, __frame, 11, 37, function ___(__0, __2) {
                    response = __2;
                    return (function __$Node_prototype__createRelationship__5(__then) {
                      if ((response.statusCode !== status.CREATED)) {
                        _ref = (response.body || {
                        }), message = _ref.message, exception = _ref.exception;
                        return (function __$Node_prototype__createRelationship__5(_) {
                          var __1 = message;
                          if (__1) {
                            return _(null, __1);
                          }
                          ;
                          return (function __$Node_prototype__createRelationship__5(_) {
                            var __2 = exception;
                            if (__2) {
                              return _(null, __2);
                            }
                            ;
                            return (function ___closure(_) {
                              switch (response.statusCode) {
                              case status.BAD_REQUEST:
                                return _(null, ((((((("Invalid createRelationship: " + from.id) + " ") + type) + " ") + to.id) + " w/ data: ") + (JSON.stringify(data))));
                              case status.CONFLICT:
                                return _(null, "\"to\" node, or the node specified by the URI not found");
                                default:
                                return _(response);
                              };
                              _();
                            })(__cb(_, __frame, 22, 32, _, true));
                          })(__cb(_, __frame, -249, 0, function ___(__0, __4) {
                            var __3 = (message = __4);
                            return _(null, __3);
                          }, true));
                        })(__cb(_, __frame, -249, 0, function __$Node_prototype__createRelationship__5() {
                          return _(new Error(message));
                        }, true));
                      }
                       else {
                        __then();
                      }
                      ;
                    })(function __$Node_prototype__createRelationship__5() {
                      return _(null, new Relationship(__this.db, response.body, from, to));
                    });
                  }, true));
                }
                 else {
                  return _(new Error("Failed to create relationship"));
                }
                ;
              })(__then);
            });
          })(function ___(_error, __result) {
            __catch(function __$Node_prototype__createRelationship__5() {
              if (_error) {
                error = _error;
                return _(adjustError(error));
              }
               else {
                _(null, __result);
              }
              ;
            }, _);
          });
        })(function ___() {
          __tryCatch(_, function __$Node_prototype__createRelationship__5() {
            _();
          });
        });
      });
    };
    Node.prototype._getRelationships = function Node_prototype__getRelationships__6(direction, type, _) {
      var error, prefix, relationshipsURL, resp, types, __this = this;
      var __frame = {
        name: "Node_prototype__getRelationships__6",
        line: 308
      };
      return __func(_, this, arguments, Node_prototype__getRelationships__6, 2, __frame, function __$Node_prototype__getRelationships__6() {
        types = null;
        if ((type != null)) {
          types = ((type instanceof Array) ? type : [type,]);
        }
        ;
        return (function ___(__then) {
          (function ___(_) {
            __tryCatch(_, function __$Node_prototype__getRelationships__6() {
              if ((types != null)) {
                prefix = __this._data[(("" + direction) + "_typed_relationships")];
                relationshipsURL = ((prefix != null) ? prefix.replace("{-list|&|types}", types.join("&")) : void 0);
              }
               else {
                relationshipsURL = __this._data[(("" + direction) + "_relationships")];
              }
              ;
              if (!relationshipsURL) {
                return _(new Error("Couldn't find URL of relationships endpoint."));
              }
              ;
              return __this._request.get(relationshipsURL, __cb(_, __frame, 25, 29, function ___(__0, __1) {
                resp = __1;
                if ((resp.statusCode === status.NOT_FOUND)) {
                  return _(new Error("Node not found."));
                }
                ;
                if ((resp.statusCode !== status.OK)) {
                  return _(new Error(("Unrecognized response code: " + resp.statusCode)));
                }
                ;
                return _(null, resp.body.map((function(_this) {
                  return function(data) {
                    if ((_this.self === data.start)) {
                      return new Relationship(_this.db, data, _this, null);
                    }
                     else {
                      return new Relationship(_this.db, data, null, _this);
                    }
                    ;
                  };
                })(__this)));
              }, true));
            });
          })(function ___(_error, __result) {
            __catch(function __$Node_prototype__getRelationships__6() {
              if (_error) {
                error = _error;
                return _(adjustError(error));
              }
               else {
                _(null, __result);
              }
              ;
            }, _);
          });
        })(function ___() {
          __tryCatch(_, function __$Node_prototype__getRelationships__6() {
            _();
          });
        });
      });
    };
    Node.prototype.getRelationships = function Node_prototype_getRelationships__7(type, _) {
      var __this = this;
      var __frame = {
        name: "Node_prototype_getRelationships__7",
        line: 360
      };
      return __func(_, this, arguments, Node_prototype_getRelationships__7, 1, __frame, function __$Node_prototype_getRelationships__7() {
        return __this.all(type, __cb(_, __frame, 1, 9, _, true));
      });
    };
    Node.prototype.outgoing = function Node_prototype_outgoing__8(type, _) {
      var __this = this;
      var __frame = {
        name: "Node_prototype_outgoing__8",
        line: 371
      };
      return __func(_, this, arguments, Node_prototype_outgoing__8, 1, __frame, function __$Node_prototype_outgoing__8() {
        return __this._getRelationships("outgoing", type, __cb(_, __frame, 1, 9, _, true));
      });
    };
    Node.prototype.incoming = function Node_prototype_incoming__9(type, _) {
      var __this = this;
      var __frame = {
        name: "Node_prototype_incoming__9",
        line: 382
      };
      return __func(_, this, arguments, Node_prototype_incoming__9, 1, __frame, function __$Node_prototype_incoming__9() {
        return __this._getRelationships("incoming", type, __cb(_, __frame, 1, 9, _, true));
      });
    };
    Node.prototype.all = function Node_prototype_all__10(type, _) {
      var __this = this;
      var __frame = {
        name: "Node_prototype_all__10",
        line: 395
      };
      return __func(_, this, arguments, Node_prototype_all__10, 1, __frame, function __$Node_prototype_all__10() {
        return __this._getRelationships("all", type, __cb(_, __frame, 1, 9, _, true));
      });
    };
    Node.prototype.getRelationshipNodes = function Node_prototype_getRelationshipNodes__11(rels, _) {
      var error, resp, traverseURL, _ref, _ref1, _ref2, __this = this;
      var __frame = {
        name: "Node_prototype_getRelationshipNodes__11",
        line: 414
      };
      return __func(_, this, arguments, Node_prototype_getRelationshipNodes__11, 1, __frame, function __$Node_prototype_getRelationshipNodes__11() {
        rels = ((rels instanceof Array) ? rels : [rels,]);
        return (function ___(__then) {
          (function ___(_) {
            __tryCatch(_, function __$Node_prototype_getRelationshipNodes__11() {
              traverseURL = (((_ref = __this._data["traverse"]) != null) ? _ref.replace("{returnType}", "node") : void 0);
              if (!traverseURL) {
                return _(new Error("Traverse not available."));
              }
              ;
              return __this._request.post({
                url: traverseURL,
                json: {
                  max_depth: 1,
                  relationships: rels.map(function(rel) {
                    if ((typeof rel === "string")) {
                      return {
                        type: rel
                      };
                    }
                     else {
                      return rel;
                    }
                    ;
                  })
                }
              }, __cb(_, __frame, 11, 29, function ___(__0, __1) {
                resp = __1;
                if ((resp.statusCode === 404)) {
                  return _(new Error((((((_ref1 = resp.body) != null) ? _ref1.message : void 0)) || "Node not found.")));
                }
                ;
                if ((resp.statusCode !== 200)) {
                  return _(new Error((((((_ref2 = resp.body) != null) ? _ref2.message : void 0)) || (("Unrecognized response code: " + resp.statusCode)))));
                }
                ;
                return _(null, resp.body.map((function(_this) {
                  return function(data) {
                    return new Node(_this.db, data);
                  };
                })(__this)));
              }, true));
            });
          })(function ___(_error, __result) {
            __catch(function __$Node_prototype_getRelationshipNodes__11() {
              if (_error) {
                error = _error;
                return _(adjustError(error));
              }
               else {
                _(null, __result);
              }
              ;
            }, _);
          });
        })(function ___() {
          __tryCatch(_, function __$Node_prototype_getRelationshipNodes__11() {
            _();
          });
        });
      });
    };
    Node.prototype.path = function Node_prototype_path__12(to, type, direction, maxDepth, algorithm, _) {
      var data, end, error, length, nodes, pathURL, relationships, res, start, __this = this;
      var __frame = {
        name: "Node_prototype_path__12",
        line: 463
      };
      return __func(_, this, arguments, Node_prototype_path__12, 5, __frame, function __$Node_prototype_path__12() {
        if ((maxDepth == null)) {
          maxDepth = 1;
        }
        ;
        if ((algorithm == null)) {
          algorithm = "shortestPath";
        }
        ;
        return (function ___(__then) {
          (function ___(_) {
            __tryCatch(_, function __$Node_prototype_path__12() {
              pathURL = (("" + __this.self) + "/path");
              data = {
                to: to.self,
                relationships: {
                  type: type,
                  direction: direction
                },
                max_depth: maxDepth,
                algorithm: algorithm
              };
              return __this._request.post({
                url: pathURL,
                json: data
              }, __cb(_, __frame, 11, 28, function ___(__0, __1) {
                res = __1;
                if ((res.statusCode === status.NOT_FOUND)) {
                  return _(null, null);
                }
                ;
                if ((res.statusCode !== status.OK)) {
                  return _(new Error(("Unrecognized response code: " + res.statusCode)));
                }
                ;
                data = res.body;
                start = new Node(__this, {
                  self: data.start
                });
                end = new Node(__this, {
                  self: data.end
                });
                length = data.length;
                nodes = data.nodes.map((function(_this) {
                  return function(url) {
                    return new Node(_this, {
                      self: url
                    });
                  };
                })(__this));
                relationships = data.relationships.map((function(_this) {
                  return function(url) {
                    return new Relationship(_this, {
                      self: url,
                      type: type
                    });
                  };
                })(__this));
                return _(null, new Path(start, end, length, nodes, relationships));
              }, true));
            });
          })(function ___(_error, __result) {
            __catch(function __$Node_prototype_path__12() {
              if (_error) {
                error = _error;
                return _(adjustError(error));
              }
               else {
                _(null, __result);
              }
              ;
            }, _);
          });
        })(function ___() {
          __tryCatch(_, function __$Node_prototype_path__12() {
            _();
          });
        });
      });
    };
    return Node;
  })(PropertyContainer);
}).call(this);
//# sourceMappingURL=Node.map
